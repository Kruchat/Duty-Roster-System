<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <!-- (Viewport and Meta tags remain the same) -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">

    <title>แอป ตารางเวรครู AI (v20 - AutoSync & Swap)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script>
        // (Tailwind config remains the same)
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] },
                    colors: { 
                        brand: { 500: '#0ea5e9', 600: '#0284c7' }, 
                        accent: { 500: '#10b981', 600: '#059669' }, 
                        ai: { 500: '#8b5cf6', 600: '#7c3aed' },
                        google: { 500: '#fbbc05', 600: '#ea4335' },
                        holiday: { 500: '#ef4444', 100: '#fee2e2' }
                    },
                    animation: {
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                        'scale-in': 'scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)',
                        'pulse-dot': 'pulseDot 1.4s infinite ease-in-out both', 
                        'fade-in': 'fadeIn 0.3s ease-out'
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        scaleIn: { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        pulseDot: {
                            '0%, 80%, 100%': { transform: 'scale(0)', opacity: 0.5 },
                            '40%': { transform: 'scale(1.0)', opacity: 1 }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* (Base styles remain the same) */
        body { 
            -webkit-tap-highlight-color: transparent; background-color: #f1f5f9; height: 100dvh; width: 100vw; 
            overflow: hidden; display: flex; align-items: center; justify-content: center; font-family: 'Sarabun', sans-serif; 
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #app-shell { 
            width: 100%; height: 100%; background: #f8fafc; position: relative; overflow: hidden; 
            display: flex; flex-direction: column; 
        }
        @media (min-width: 768px) { 
            #app-shell { 
                max-width: 420px; height: 850px; max-height: 90dvh; border-radius: 40px; 
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3); border: 4px solid #e2e8f0; 
            } 
        }
        /* (Nav styles remain the same) */
        .bottom-nav {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-top: 1px solid rgba(0,0,0,0.05);
            display: flex; position: relative; z-index: 50; padding: 8px 8px 0 8px;
            padding-bottom: env(safe-area-inset-bottom, 8px);
        }
        .nav-item {
            flex: 1; text-align: center; padding: 10px 5px; font-size: 11px; font-weight: 600; color: #64748b; 
            z-index: 2; cursor: pointer; transition: color 0.2s; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; gap: 2px;
        }
        .nav-item.active { color: #0284c7; background-color: #f0f9ff; }
        #nav-chat.active { color: #7c3aed; background-color: #f5f3ff; }
        .nav-item i { font-size: 16px; line-height: 1; }

        /* (Segmented control styles remain the same) */
        .segmented-control { background: #e2e8f0; padding: 4px; border-radius: 12px; display: flex; position: relative; }
        .segmented-item { flex: 1; text-align: center; padding: 6px; font-size: 12px; font-weight: 600; color: #64748b; z-index: 2; cursor: pointer; transition: color 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .segmented-item.active { color: #0284c7; }
        .segmented-bg { position: absolute; top: 4px; bottom: 4px; left: 4px; width: calc(50% - 4px); background: white; border-radius: 8px; shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* (Calendar styles remain the same) */
        #calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 2px; }
        .calendar-day { 
            position: relative; height: 0; padding-bottom: 110%; background-color: white; 
            border: 1px solid #f1f5f9; border-radius: 8px; overflow: hidden; cursor: pointer; 
            transition: background-color 0.2s;
        }
        .calendar-day:hover { background-color: #f8fafc; }
        .calendar-day-empty { background-color: #f8fafc; border: 1px solid #f8fafc; cursor: default; }
        .day-number { position: absolute; top: 4px; left: 6px; font-size: 10px; font-weight: 600; color: #94a3b8; }
        .day-today .day-number { background-color: #0284c7; color: white; width: 18px; height: 18px; border-radius: 99px; display: flex; align-items: center; justify-content: center; top: 3px; left: 3px; font-size: 9px; }
        .duty-chip-container { position: absolute; top: 24px; left: 0; right: 0; bottom: 4px; overflow-y: auto; -ms-overflow-style: none; scrollbar-width: none; }
        .duty-chip-container::-webkit-scrollbar { display: none; }
        
        .duty-chip { 
            display: block; font-size: 9px; font-weight: 600; color: #0369a1; 
            background-color: #e0f2fe; padding: 2px 4px; margin: 0 4px 3px 4px; 
            border-radius: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; 
            cursor: grab; 
            transition: all 0.2s;
        }
        .holiday-chip {
            display: block; font-size: 9px; font-weight: 600; color: #b91c1c; 
            background-color: #fee2e2; padding: 2px 4px; margin: 0 4px 3px 4px; 
            border-radius: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .day-holiday .day-number { color: #ef4444; font-weight: 700; }
        
        /* (อัปเกรด) v20: สไตล์สำหรับการ Drag & Drop (Swap) */
        .duty-chip.dragging {
            opacity: 0.5;
            transform: scale(0.95);
            background-color: #dbeafe;
        }
        /* (ใหม่) v20: สไตล์ Chip เป้าหมาย (สำหรับสลับ) */
        .duty-chip.swap-target {
            outline: 2px dashed #0ea5e9;
            background-color: #f0f9ff;
            transform: scale(1.05);
        }

        /* (Form styles remain the same) */
        .form-label { display: block; text-transform: uppercase; font-size: 11px; font-weight: 700; color: #475569; margin-bottom: 6px; letter-spacing: 0.5px; }
        .form-input, .form-textarea, .form-select { width: 100%; background: white; border: 1px solid #cbd5e1; border-radius: 12px; padding: 10px 14px; font-size: 14px; color: #1e293b; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.02); }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: #0ea5e9; box-shadow: 0 0 0 3px #bfdbfe; }
        .form-textarea { min-height: 120px; resize: vertical; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px 20px; border-radius: 14px; font-size: 14px; font-weight: 600; transition: all 0.2s; cursor: pointer; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .btn-primary { background-color: #0ea5e9; color: white; }
        .btn-primary:hover { background-color: #0284c7; }
        .btn-secondary { background-color: #e2e8f0; color: #334155; }
        .btn-secondary:hover { background-color: #cbd5e1; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* (Chat UI v17 styles remain the same) */
        #view-chat { 
            display: flex; flex-direction: column; height: 100%; padding: 0; 
            background-color: #f1f5f9; 
        }
        #chat-message-container { 
            flex: 1; overflow-y: auto; padding: 16px; 
            display: flex; flex-direction: column; gap: 12px; 
        }
        .chat-bubble { max-width: 80%; padding: 10px 16px; border-radius: 20px; font-size: 15px; line-height: 1.5; word-wrap: break-word; }
        .chat-bubble-user { background-color: #0ea5e9; color: white; border-bottom-right-radius: 5px; align-self: flex-end; }
        .chat-bubble-ai { 
            background-color: #ffffff; 
            color: #334155; border: 1px solid #e2e8f0; 
            border-bottom-left-radius: 5px; align-self: flex-start; 
            display: flex; gap: 8px; align-items: center; 
        }
        .chat-bubble-ai i { color: #8b5cf6; }
        #chat-form-container {
            background-color: #f8fafc;
            border-top: 1px solid #e2e8f0;
            padding: 16px;
            padding-bottom: calc(env(safe-area-inset-bottom, 0) + 16px);
        }
        #image-preview-container {
            position: relative;
            display: none; 
            margin-bottom: 12px;
            max-width: 200px;
        }
        #image-preview-container img {
            width: 100%; max-height: 200px; object-fit: cover;
            border-radius: 12px; border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        #remove-image-btn {
            position: absolute; top: -10px; right: -10px;
            width: 28px; height: 28px; border-radius: 99px;
            background-color: #334155; color: white; border: 2px solid white;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        #chat-input-row { display: flex; gap: 10px; align-items: flex-end; }
        #chat-input { 
            flex: 1; background-color: white; border: 1px solid #cbd5e1; 
            border-radius: 16px; padding: 12px 18px; font-size: 15px; 
            transition: all 0.2s; resize: none; max-height: 120px; 
        }
        #chat-input:focus { outline: none; border-color: #8b5cf6; box-shadow: 0 0 0 3px #ddd6fe; }
        .chat-btn {
            width: 48px; height: 48px; border-radius: 99px;
            color: white; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; transition: all 0.2s;
        }
        #attach-btn { background-color: #94a3b8; }
        #attach-btn:hover { background-color: #64748b; }
        #chat-send-btn { background-color: #8b5cf6; }
        #chat-send-btn:hover { background-color: #7c3aed; }
        #chat-send-btn:disabled { background-color: #c4b5fd; cursor: not-allowed; opacity: 0.7; }
        #attach-btn:disabled { background-color: #cbd5e1; cursor: not-allowed; opacity: 0.7; }
        #chat-input:disabled { background-color: #f1f5f9; }
        .chat-bubble-ai-typing { background-color: #ffffff; color: #334155; border: 1px solid #e2e8f0; border-bottom-left-radius: 5px; align-self: flex-start; display: flex; gap: 10px; align-items: center; padding: 14px 16px; }
        .typing-dot { width: 8px; height: 8px; background-color: #94a3b8; border-radius: 50%; animation: pulseDot 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        /* (Instructions-box styles remain the same) */
        .instructions-box { background-color: #f1f5f9; border-radius: 8px; padding: 12px; font-size: 13px; color: #475569; }
        .instructions-box code { background-color: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
        .instructions-box ol { list-style: decimal; padding-left: 20px; margin-top: 8px; }
        .instructions-box summary { font-weight: 600; cursor: pointer; }
        
        /* (Modal styles remain the same) */
        #modal-backdrop {
            position: fixed; inset: 0; z-index: 1000;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease-out;
        }
        #day-detail-modal {
            position: fixed; z-index: 1001;
            bottom: 0; left: 0; right: 0;
            background-color: #f8fafc;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            padding: 24px;
            padding-bottom: calc(env(safe-area-inset-bottom, 0) + 24px);
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 80vh;
            overflow-y: auto;
        }
        @media (min-width: 768px) {
            #day-detail-modal {
                left: 50%; bottom: auto; top: 50%;
                transform: translate(-50%, -50%);
                max-width: 420px; width: 100%;
                border-radius: 24px;
                animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            }
            #modal-backdrop { background-color: rgba(0, 0, 0, 0.4); }
        }
    </style>
</head>
<body>

    <!-- (Toast, File Inputs, Modal HTML remain the same) -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 z-[6000] opacity-0 pointer-events-none transition-all duration-300 translate-y-[-20px] bg-slate-800/95 text-white px-5 py-3 rounded-full shadow-xl backdrop-blur-md flex items-center gap-3 text-sm font-medium border border-slate-700/50">
        <!-- content -->
    </div>
    <input type="file" id="import-file-input" class="hidden" accept=".json, .txt" onchange="window.handleFileImport(event)">
    <input type="file" id="image-upload-input" class="hidden" accept="image/png, image/jpeg" onchange="window.handleImageUpload(event)">

    <div id="modal-container" class="hidden">
        <div id="modal-backdrop" onclick="window.hideDayDetails()"></div>
        <div id="day-detail-modal">
            <h3 id="modal-date" class="text-xl font-bold text-slate-800">...</h3>
            <div class="mt-4">
                <h4 class="text-sm font-bold text-holiday-500 uppercase tracking-wide">วันหยุดราชการ</h4>
                <div id="modal-holiday-list" class="mt-2 text-slate-600"></div>
            </div>
            <div class="mt-4">
                <h4 class="text-sm font-bold text-brand-600 uppercase tracking-wide">เวรที่ได้รับมอบหมาย</h4>
                <div id="modal-duty-list" class="mt-2 space-y-2 text-slate-600"></div>
            </div>
            <button onclick="window.hideDayDetails()" class="btn btn-secondary w-full mt-6">
                ปิด
            </button>
        </div>
    </div>

    <main id="app-shell">

        <!-- (Header remains the same) -->
        <header class="px-6 py-4 flex justify-between items-center sticky top-0 shadow-sm bg-white/80 z-40 backdrop-blur-md border-b border-slate-100/80">
            <div class="flex flex-col">
                <h1 class="text-xl font-bold text-brand-600">ตารางเวรครู AI</h1>
                <p id="header-subtitle" class="text-sm text-slate-500">ประจำวันนี้</p>
            </div>
            <div id="header-icon-container" class="w-12 h-12 bg-sky-100 rounded-full flex items-center justify-center text-sky-600 border-4 border-white shadow-md">
                <i id="header-icon" class="fa-solid fa-calendar-check text-xl"></i>
            </div>
        </header>

        <div id="content-area" class="flex-1 overflow-y-auto no-scrollbar pb-6">
            
            <!-- (View 1: Home - remains the same) -->
            <section id="view-home" class="p-6">
                <div class="bg-gradient-to-br from-brand-500 to-brand-600 text-white p-6 rounded-3xl shadow-xl shadow-sky-200 animate-scale-in mb-6">
                    <span class="text-sm font-light opacity-80" id="today-date">...</span>
                    <h2 class="text-2xl font-bold tracking-tight mt-1 mb-4">เวรประจำวันนี้</h2>
                    <div id="today-duty-list" class="space-y-3">
                        <p class="text-sky-100">กำลังโหลดข้อมูล...</p>
                    </div>
                </div>
                <h3 class="text-lg font-bold text-slate-700 mb-3 px-1">เมนูด่วน</h3>
                <div class="grid grid-cols-2 gap-4">
                     <button onclick="window.switchView('view-roster')" class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-2 hover:border-brand-300 hover:bg-sky-50 transition">
                        <i class="fa-solid fa-calendar-days text-brand-500 text-2xl"></i>
                        <span class="text-sm font-semibold text-slate-700">ดูตารางทั้งหมด</span>
                    </button>
                    <button onclick="window.switchView('view-chat')" class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-2 hover:border-ai-300 hover:bg-violet-50 transition">
                        <i class="fa-solid fa-wand-magic-sparkles text-ai-500 text-2xl"></i>
                        <span class="text-sm font-semibold text-slate-700">แชทกับ AI</span>
                    </button>
                </div>
            </section>

            <!-- (View 2: Roster - remains the same) -->
            <section id="view-roster" class="hidden p-6 space-y-4">
                <div class="segmented-control">
                    <div class="segmented-bg" id="roster-view-bg" style="transform: translateX(100%);"></div>
                    <div class="segmented-item" onclick="window.switchRosterView(0)">
                        <i class="fa-solid fa-list-ul"></i> <span>รายการ</span>
                    </div>
                    <div class="segmented-item active" onclick="window.switchRosterView(1)">
                        <i class="fa-solid fa-calendar-alt"></i> <span>ปฏิทิน</span>
                    </div>
                </div>
                <div id="roster-list-container" class="space-y-3 hidden">
                    <!-- JS populates this -->
                </div>
                <div id="calendar-view-container" class="space-y-3">
                    <div class="flex justify-between items-center px-2">
                        <button onclick="window.changeMonth(-1)" class="w-10 h-10 flex items-center justify-center text-slate-500 hover:bg-slate-100 rounded-full transition"><i class="fa-solid fa-chevron-left"></i></button>
                        <h3 id="calendar-month-year" class="text-lg font-bold text-slate-700"></h3>
                        <button onclick="window.changeMonth(1)" class="w-10 h-10 flex items-center justify-center text-slate-500 hover:bg-slate-100 rounded-full transition"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                    <div class="grid grid-cols-7 gap-2 text-center text-[10px] font-bold text-slate-400 mb-2 px-1">
                        <span>อา</span><span>จ</span><span>อ</span><span>พ</span><span>พฤ</span><span>ศ</span><span>ส</span>
                    </div>
                    <div id="calendar-grid">
                        <!-- JS populates this -->
                    </div>
                </div>
            </section>

            <!-- (View 3: Chat AI - remains the same) -->
            <section id="view-chat" class="hidden">
                <div id="chat-message-container" class="no-scrollbar">
                    <!-- JS populates this -->
                </div>
                <div id="chat-form-container">
                    <div id="image-preview-container">
                        <!-- JS populates this -->
                    </div>
                    <form id="chat-form" onsubmit="window.sendChatMessage(event)">
                        <div id="chat-input-row">
                            <button id="attach-btn" type="button" class="chat-btn" onclick="window.triggerImageUpload()">
                                <i class="fa-solid fa-paperclip"></i>
                            </button>
                            <textarea id="chat-input" placeholder="พิมพ์คำสั่งหรือแนบรูปภาพ..." rows="1"></textarea>
                            <button id="chat-send-btn" type="submit" class="chat-btn">
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- (View 4: Manage - v20 update) -->
            <section id="view-manage" class="hidden p-6 space-y-6">
                
                <!-- (Holiday Sync - v18 update) -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-700">จัดการวันหยุดราชการ</h3>
                        <i class="fa-solid fa-mountain-sun text-2xl text-holiday-500"></i>
                    </div>
                    
                    <div>
                        <label for="input-holiday-year" class="form-label">ปี (ค.ศ.) ที่ต้องการค้นหา</label>
                        <input type="number" id="input-holiday-year" class="form-input" placeholder="เช่น 2026" min="2020" max="2099">
                    </div>

                    <button id="btn-sync-holidays" onclick="window.syncHolidays()" class="btn w-full bg-holiday-500 text-white hover:bg-holiday-600 mt-4">
                        <i class="fa-solid fa-magnifying-glass-chart mr-2"></i> อัปเดตวันหยุด (AI Search)
                    </button>
                    
                    <p class="text-xs text-slate-500 mt-4">
                        ข้อมูลวันหยุดที่ซิงค์มา (ระบบจะผสานข้อมูลให้):
                    </p>
                    <div id="holiday-list-container" class="mt-2 max-h-32 overflow-y-auto no-scrollbar space-y-1">
                        <!-- JS Populates this -->
                    </div>
                </div>

                <!-- (Google Sheet Sync - v20 update) -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-700">Google Sheet Sync</h3>
                        <i class="fa-brands fa-google-drive text-2xl text-google-500"></i>
                    </div>
                    <div>
                        <label for="input-apps-script-url" class="form-label">Google Apps Script URL</label>
                        <input type="url" id="input-apps-script-url" class="form-input" placeholder="https://script.google.com/macros/s/..." oninput="window.saveAppsScriptUrl(this.value)">
                    </div>
                    <!-- (ใหม่) v20: ลบปุ่ม Sync, เพิ่มข้อความ Auto-sync -->
                    <p class="text-sm text-slate-600 mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
                        <i class="fa-solid fa-circle-info mr-1 text-green-600"></i>
                        ระบบจะ Sync อัตโนมัติเมื่อมีการเปลี่ยนแปลงข้อมูล (เช่น สั่ง AI, ลากสลับเวร, นำเข้าไฟล์)
                    </p>
                    
                    <details class="mt-4">
                        <summary class="instructions-box summary">
                            <i class="fa-solid fa-info-circle"></i> วิธีรับ URL (คลิกเพื่ออ่าน)
                        </summary>
                        <div class="instructions-box mt-2 space-y-2">
                            <ol class="space-y-1">
                                <li>ไปที่ <code>sheets.new</code> &gt; <code>ส่วนขยาย &gt; Apps Script</code></li>
                                <li>วางโค้ดจากช่องถัดไป</li>
                                <li><code>Deploy &gt; New deployment &gt; Web app</code></li>
                                <li>ตั้งค่า "Who has access" เป็น <code>Anyone</code></li>
                                <li>กด Deploy, อนุญาตสิทธิ์, และคัดลอก URL มาวาง</li>
                            </ol>
                        </div>
                    </details>
                    <details class="mt-2">
                         <summary class="instructions-box summary">
                            <i class="fa-solid fa-code"></i> โค้ดสำหรับ Apps Script (Code.gs)
                        </summary>
                        <div class="instructions-box mt-2">
                            <pre class="overflow-x-auto p-2 bg-slate-700 text-white rounded-md text-xs"><code>function doPost(e) {
  try {
    var sheetName = "RosterData";
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
    if (!sheet) {
      sheet = SpreadsheetApp.getActiveSpreadsheet().insertSheet(sheetName);
    }
    var data = JSON.parse(e.postData.contents);
    sheet.clear();
    var headers = ["date", "teacher", "duty"];
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight("bold");
    var values = data.map(function(row) {
      return [row.date, row.teacher, row.duty];
    });
    if (values.length > 0) {
      sheet.getRange(2, 1, values.length, headers.length).setValues(values);
      sheet.autoResizeColumns(1, headers.length);
    }
    return ContentService.createTextOutput(JSON.stringify({ status: "success", rows_synced: values.length })).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ status: "error", message: error.message })).setMimeType(ContentService.MimeType.JSON);
  }
}</code></pre>
                        </div>
                    </details>
                </div>
                
                <!-- (Import/Export - remains the same) -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-bold text-slate-700 mb-4">นำเข้า / ส่งออก ข้อมูล</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="window.exportBackup()" class="btn btn-secondary">
                            <i class="fa-solid fa-download mr-2"></i> บันทึกลงเครื่อง
                        </button>
                        <button onclick="window.triggerImport()" class="btn btn-secondary">
                            <i class="fa-solid fa-upload mr-2"></i> นำเข้าจากเครื่อง
                        </button>
                    </div>
                </div>

                <!-- (AI Settings - remains the same) -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-bold text-slate-700 mb-4">ตั้งค่า AI</h3>
                    <div>
                        <label for="input-api-key" class="form-label">Gemini API Key</label>
                        <div class="relative">
                            <input type="password" id="input-api-key" class="form-input pr-10" placeholder="กรอก API Key ของคุณ" oninput="window.saveApiKey(this.value)">
                            <button onclick="window.toggleKeyVisibility()" class="absolute top-1/2 right-3 -translate-y-1/2 text-slate-400 hover:text-slate-600">
                                <i id="api-key-eye" class="fa-solid fa-eye-slash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label for="input-ai-model" class="form-label">AI Model (v20: แนะนำ 2.5 Flash)</label>
                        <select id="input-ai-model" class="form-select" onchange="window.saveAiModel(this.value)">
                            <option value="gemini-2.5-flash-preview-09-2025">Gemini 2.5 Flash (Preview)</option>
                            <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash (Latest)</option>
                            <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro (Latest)</option>
                        </select>
                    </div>
                </div>
                
                <!-- (JSON Data - remains the same) -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-bold text-slate-700 mb-4">จัดการข้อมูล (JSON)</h3>
                    <div>
                        <label for="input-roster-data" class="form-label">ข้อมูลตารางเวร (JSON Array)</label>
                        <textarea id="input-roster-data" class="form-textarea" rows="8"></textarea>
                    </div>
                    <button onclick="window.saveRosterData()" class="btn btn-secondary w-full mt-4">
                        <i class="fa-solid fa-save mr-2"></i> บันทึกข้อมูล
                    </button>
                </div>

            </section>
        </div>

        <!-- (Bottom Nav - remains the same) -->
        <nav id="bottom-nav" class="bottom-nav shrink-0">
            <div id="nav-home" class="nav-item active" onclick="window.switchView('view-home')">
                <i class="fa-solid fa-house"></i>
                <span>หน้าหลัก</span>
            </div>
            <div id="nav-roster" class="nav-item" onclick="window.switchView('view-roster')">
                <i class="fa-solid fa-calendar-days"></i>
                <span>ตารางเวร</span>
            </div>
            <div id="nav-chat" class="nav-item" onclick="window.switchView('view-chat')">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                <span>แชท AI</span>
            </div>
            <div id="nav-manage" class="nav-item" onclick="window.switchView('view-manage')">
                <i class="fa-solid fa-sliders"></i>
                <span>จัดการ</span>
            </div>
        </nav>
    </main>

    <script type="module">
        // --- STATE & DOM ---
        let state = {
            roster: [],
            holidays: [], 
            chatHistory: [], 
            calendarMonth: new Date(),
            isAiThinking: false,
            attachedFile: { base64: null, mimeType: null, dataUrl: null }
        };
        
        const dom = {
            // (อัปเกรด) v20: ลบ btnSyncGSheet
            views: { home: document.getElementById('view-home'), roster: document.getElementById('view-roster'), chat: document.getElementById('view-chat'), manage: document.getElementById('view-manage') },
            nav: { home: document.getElementById('nav-home'), roster: document.getElementById('nav-roster'), chat: document.getElementById('nav-chat'), manage: document.getElementById('nav-manage') },
            headerSubtitle: document.getElementById('header-subtitle'),
            headerIconContainer: document.getElementById('header-icon-container'), 
            headerIcon: document.getElementById('header-icon'), 
            todayDate: document.getElementById('today-date'),
            todayDutyList: document.getElementById('today-duty-list'),
            rosterListContainer: document.getElementById('roster-list-container'),
            calendarViewContainer: document.getElementById('calendar-view-container'),
            rosterViewBg: document.getElementById('roster-view-bg'),
            calendarMonthYear: document.getElementById('calendar-month-year'),
            calendarGrid: document.getElementById('calendar-grid'),
            chatMessageContainer: document.getElementById('chat-message-container'),
            chatForm: document.getElementById('chat-form-container'), 
            chatInput: document.getElementById('chat-input'),
            chatSendBtn: document.getElementById('chat-send-btn'),
            inputRosterData: document.getElementById('input-roster-data'),
            importFileInput: document.getElementById('import-file-input'),
            inputApiKey: document.getElementById('input-api-key'),
            inputAiModel: document.getElementById('input-ai-model'),
            apiKeyEye: document.getElementById('api-key-eye'),
            toast: document.getElementById('toast'),
            inputAppsScriptUrl: document.getElementById('input-apps-script-url'),
            // btnSyncGSheet: (ลบออก),
            btnSyncHolidays: document.getElementById('btn-sync-holidays'),
            holidayListContainer: document.getElementById('holiday-list-container'),
            modalContainer: document.getElementById('modal-container'),
            modalBackdrop: document.getElementById('modal-backdrop'),
            dayDetailModal: document.getElementById('day-detail-modal'),
            modalDate: document.getElementById('modal-date'),
            modalHolidayList: document.getElementById('modal-holiday-list'),
            modalDutyList: document.getElementById('modal-duty-list'),
            attachBtn: document.getElementById('attach-btn'),
            imageUploadInput: document.getElementById('image-upload-input'),
            imagePreviewContainer: document.getElementById('image-preview-container'),
            inputHolidayYear: document.getElementById('input-holiday-year')
        };

        // --- DATE & DUMMY DATA ---
        const DEMO_DATE_TODAY = new Date("2025-11-15T10:00:00+07:00"); 
        const DUMMY_DATA = [
            { date: "2025-11-15", teacher: "ครูสมชาย (Demo)", duty: "เวรหน้าเสาธง" },
            { date: "2025-11-15", teacher: "ครูสมหญิง (Demo)", duty: "เวรประตูหน้า" },
            { date: "2025-11-16", teacher: "ครูวิชัย (Demo)", duty: "เวรหน้าเสาธง" },
            { date: "2025-11-17", teacher: "ครูมานะ", duty: "เวรหน้าเสาธง" },
            { date: "2025-11-17", teacher: "ครูอารี", duty: "เวรประตู" },
        ];
        
        // --- INITIALIZATION ---
        function initApp() {
            // (Initialization logic remains the same as v18)
            loadRosterData();
            loadHolidays(); 
            loadChatHistory(); 
            loadApiKey();
            loadAiModel();
            loadAppsScriptUrl(); 
            
            window.switchView('view-home'); 
            
            dom.chatInput.addEventListener('input', () => {
                dom.chatInput.style.height = 'auto'; 
                dom.chatInput.style.height = `${dom.chatInput.scrollHeight}px`;
            });

            dom.chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    document.getElementById('chat-form').dispatchEvent(new Event('submit', { cancelable: true }));
                }
            });
            
            document.getElementById('chat-form').addEventListener('submit', window.sendChatMessage);
            
            state.calendarMonth = new Date(DEMO_DATE_TODAY.getFullYear(), DEMO_DATE_TODAY.getMonth(), 1);
            
            if (state.chatHistory.length === 0) {
                state.chatHistory.push({
                    role: 'ai',
                    text: 'สวัสดีค่ะ ฉันคือ AI ผู้ช่วย (v20) ตอนนี้คุณสามารถ "ลาก" เวรทับกันเพื่อ "สลับ" วันที่ได้แล้วนะคะ'
                });
                saveChatHistory();
            }
        }

        // --- NAVIGATION & UTILS ---
        
        window.switchView = (id) => {
            // (Function remains the same)
            Object.values(dom.views).forEach(el => {
                el.classList.add('hidden');
                if (el.id === 'view-chat') el.style.display = 'none';
            });
            
            const viewId = id.split('-')[1]; 
            if (dom.views[viewId]) {
                if (viewId === 'chat') {
                    dom.views[viewId].classList.remove('hidden');
                    dom.views[viewId].style.display = 'flex'; 
                } else {
                    dom.views[viewId].classList.remove('hidden');
                }
            }
            
            Object.values(dom.nav).forEach(el => el.classList.remove('active'));
            const navId = id.split('-')[1]; 
            if (dom.nav[navId]) dom.nav[navId].classList.add('active');
            
            updateHeader(id);
            
            switch(id) {
                case 'view-home': renderHome(); break;
                case 'view-roster': renderRosterList(); renderCalendarView(); break;
                case 'view-chat': renderChatHistory(); break; 
                case 'view-manage': renderManage(); break;
            }
        }

        /** (อัปเกรด) v20: อัปเดต Subtitle */
        function updateHeader(id) {
            let subtitle = "ประจำวันนี้";
            let iconClass = "fa-solid fa-calendar-check";
            let bgColor = "bg-sky-100";
            let textColor = "text-sky-600";

            switch(id) {
                case 'view-roster':
                    subtitle = "ตารางเวร (ลากเพื่อสลับ)";
                    iconClass = "fa-solid fa-calendar-days";
                    break;
                case 'view-chat':
                    subtitle = "ผู้ช่วย AI (Search & Attach)";
                    iconClass = "fa-solid fa-wand-magic-sparkles";
                    bgColor = "bg-violet-100";
                    textColor = "text-violet-600";
                    break;
                case 'view-manage':
                    subtitle = "ตั้งค่า & จัดการข้อมูล";
                    iconClass = "fa-solid fa-sliders";
                    bgColor = "bg-slate-100";
                    textColor = "text-slate-600";
                    break;
            }
            
            dom.headerSubtitle.textContent = subtitle;
            dom.headerIcon.className = `${iconClass} text-xl`;
            dom.headerIconContainer.className = `w-12 h-12 ${bgColor} ${textColor} rounded-full flex items-center justify-center border-4 border-white shadow-md`;
        }

        function showToast(msg, type='success') {
            // (Function remains the same)
            dom.toast.innerHTML = (type === 'success' ? `<i class="fa-solid fa-check-circle text-emerald-400"></i>` : `<i class="fa-solid fa-times-circle text-red-400"></i>`) + msg;
            dom.toast.classList.remove('opacity-0', 'translate-y-[-20px]');
            dom.toast.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                dom.toast.classList.remove('opacity-100', 'translate-y-0');
                dom.toast.classList.add('opacity-0', 'translate-y-[-20px]');
            }, 3000);
        }

        function getTodayString(format = 'long') {
            // (Function remains the same)
            const today = DEMO_DATE_TODAY; 
            if (format === 'iso') return today.toLocaleDateString('sv-SE'); 
            return today.toLocaleDateString('th-TH', { 
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' 
            });
        }
        
        // (API/Model save/load... all remain the same)
        window.saveApiKey = (v) => { localStorage.setItem('teacher_roster_api_key', v); };
        window.loadApiKey = () => {
            const k = localStorage.getItem('teacher_roster_api_key');
            if (k) dom.inputApiKey.value = k;
        };
        window.toggleKeyVisibility = () => {
            if (dom.inputApiKey.type === 'password') {
                dom.inputApiKey.type = 'text';
                dom.apiKeyEye.classList.remove('fa-eye-slash'); dom.apiKeyEye.classList.add('fa-eye');
            } else {
                dom.inputApiKey.type = 'password';
                dom.apiKeyEye.classList.remove('fa-eye'); dom.apiKeyEye.classList.add('fa-eye-slash');
            }
        };
        window.saveAiModel = (v) => { localStorage.setItem('teacher_roster_ai_model', v); };
        window.loadAiModel = () => {
             const m = localStorage.getItem('teacher_roster_ai_model');
             dom.inputAiModel.value = m || 'gemini-2.5-flash-preview-09-2025';
        };

        // --- DATA & RENDERING LOGIC ---

        // (renderHome, renderRosterList, renderManage... remain the same as v18)
        function renderHome() {
            dom.todayDate.textContent = getTodayString('long');
            const todayISO = getTodayString('iso');
            const todayDuties = state.roster.filter(item => item.date === todayISO);
            const todayHoliday = state.holidays.find(item => item.date === todayISO); 

            if (todayDuties.length === 0 && !todayHoliday) {
                dom.todayDutyList.innerHTML = `
                    <div class="flex items-center gap-3 bg-white/10 p-4 rounded-xl backdrop-blur-sm">
                        <i class="fa-solid fa-mug-saucer text-2xl text-white opacity-80"></i>
                        <div><p class="font-bold text-white">ไม่มีเวรประจำวันนี้</p><p class="text-sm text-sky-100 opacity-90">พักผ่อนได้ตามอัธยาศัย</p></div>
                    </div>`;
                return;
            }

            let html = '';
            
            if (todayHoliday) {
                html += `
                <div class="flex items-center gap-4 bg-white/10 p-4 rounded-xl backdrop-blur-sm animate-slide-up">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center shrink-0"><i class="fa-solid fa-mountain-sun text-white text-lg"></i></div>
                    <div><p class="font-bold text-white">${todayHoliday.name}</p><p class="text-sm text-sky-100 opacity-90">วันหยุดราชการ</p></div>
                </div>`;
            }

            html += todayDuties.map(item => `
                <div class="flex items-center gap-4 bg-white/10 p-4 rounded-xl backdrop-blur-sm animate-slide-up">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center shrink-0"><i class="fa-solid fa-user-check text-white text-lg"></i></div>
                    <div><p class="font-bold text-white">${item.teacher}</p><p class="text-sm text-sky-100 opacity-90">${item.duty}</p></div>
                </div>
            `).join('');
            
            dom.todayDutyList.innerHTML = html;
        }
        
        function renderRosterList() {
            if (state.roster.length === 0 && state.holidays.length === 0) {
                dom.rosterListContainer.innerHTML = `<p class="text-center text-slate-500 mt-8">ไม่มีข้อมูลตารางเวร</p>`;
                return;
            }
            
            const combined = [
                ...state.roster,
                ...state.holidays.map(h => ({ ...h, teacher: "วันหยุด", duty: h.name }))
            ];

            const grouped = combined.reduce((acc, item) => {
                (acc[item.date] = acc[item.date] || []).push(item);
                return acc;
            }, {});
            
            const sortedDates = Object.keys(grouped).sort();
            
            dom.rosterListContainer.innerHTML = sortedDates.map(date => {
                const items = grouped[date];
                const d = new Date(date + "T00:00:00"); 
                const dateHeader = d.toLocaleDateString('th-TH', { weekday: 'long', day: 'numeric', month: 'short' });
                return `
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 animate-slide-up">
                    <h4 class="font-bold text-brand-600 mb-2 pb-2 border-b border-slate-100">${dateHeader}</h4>
                    <div class="space-y-2">
                    ${items.map(item => {
                        const isHoliday = item.teacher === "วันหยุด";
                        return `<div class="flex gap-3">
                                    <span class="font-semibold ${isHoliday ? 'text-holiday-500' : 'text-slate-700'} w-2/5 truncate">${item.teacher}</span>
                                    <span class="${isHoliday ? 'text-holiday-500/80' : 'text-slate-500'} flex-1">${item.duty}</span>
                                </div>`
                    }).join('')}
                    </div>
                </div>`;
            }).join('');
        }
        
        function renderManage() {
            dom.inputRosterData.value = JSON.stringify(state.roster, null, 2);
            loadApiKey();
            loadAiModel();
            loadAppsScriptUrl(); 
            renderHolidayList(); 
            const currentYear = DEMO_DATE_TODAY.getFullYear(); 
            dom.inputHolidayYear.value = currentYear;
        }

        // --- Chat Rendering ---
        // (Chat rendering functions remain the same)
        function renderChatHistory() {
            dom.chatMessageContainer.innerHTML = state.chatHistory.map(msg => {
                if (msg.role === 'user') {
                    return `<div class="chat-bubble chat-bubble-user">${escapeHTML(msg.text)}</div>`;
                } else {
                    return `<div class="chat-bubble chat-bubble-ai">
                                <i class="fa-solid fa-robot fa-fw"></i>
                                <span>${escapeHTML(msg.text)}</span>
                            </div>`;
                }
            }).join('');
            
            if (state.isAiThinking) {
                addTypingIndicator();
            }
            
            scrollToChatBottom();
        }

        function escapeHTML(str) {
            if (!str) return ""; 
            return str.replace(/[&<>"']/g, function(match) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match];
            });
        }
        
        function scrollToChatBottom() {
            dom.chatMessageContainer.scrollTop = dom.chatMessageContainer.scrollHeight;
        }

        // --- DATA PERSISTENCE ---
        // (Data persistence functions remain the same)
        function loadRosterData() {
            const data = localStorage.getItem('teacher_roster_data_v2');
            if (data) {
                try {
                    state.roster = JSON.parse(data);
                    if (!data || state.roster.length === 0) {
                         state.roster = [...DUMMY_DATA];
                    }
                } catch (e) { state.roster = [...DUMMY_DATA]; }
            } else {
                state.roster = [...DUMMY_DATA]; 
            }
            sortRoster();
        }
        function saveRosterToStorage() {
            try {
                localStorage.setItem('teacher_roster_data_v2', JSON.stringify(state.roster));
            } catch (e) { showToast('ไม่สามารถบันทึกข้อมูลได้ (อาจจะเต็ม)', 'error'); }
        }
        function sortRoster() {
            state.roster.sort((a, b) => a.date.localeCompare(b.date) || a.teacher.localeCompare(b.teacher));
        }
        window.saveRosterData = () => {
            try {
                const newData = JSON.parse(dom.inputRosterData.value);
                if (Array.isArray(newData)) {
                    state.roster = newData;
                    sortRoster();
                    saveRosterToStorage();
                    showToast('บันทึกข้อมูลเรียบร้อยแล้ว');
                    renderHome(); renderRosterList(); renderCalendarView();
                    window.triggerAutoSync(); // (ใหม่) v20: Auto-sync
                } else { showToast('รูปแบบข้อมูลไม่ถูกต้อง (ต้องเป็น Array)', 'error'); }
            } catch (e) { showToast(`เกิดข้อผิดพลาด: ${e.message}`, 'error'); }
        };
        function loadChatHistory() {
            const data = localStorage.getItem('teacher_roster_chat_history_v1');
            if (data) {
                try { state.chatHistory = JSON.parse(data); } catch (e) { state.chatHistory = []; }
            } else { state.chatHistory = []; }
        }
        function saveChatHistory() {
            try {
                const recentHistory = state.chatHistory.slice(-50);
                localStorage.setItem('teacher_roster_chat_history_v1', JSON.stringify(recentHistory));
            } catch (e) { console.error("Failed to save chat history:", e); }
        }
        window.saveAppsScriptUrl = (v) => { localStorage.setItem('teacher_roster_gas_url', v); };
        window.loadAppsScriptUrl = () => {
            const url = localStorage.getItem('teacher_roster_gas_url');
            if (url) dom.inputAppsScriptUrl.value = url;
        };
        function loadHolidays() {
            const data = localStorage.getItem('teacher_roster_holidays_v1');
            if (data) {
                try { state.holidays = JSON.parse(data); } catch(e) { state.holidays = []; }
            } else {
                state.holidays = [
                    { date: "2025-12-05", name: "วันคล้ายวันพระบรมราชสมภพ ร.9" },
                    { date: "2025-12-10", name: "วันรัฐธรรมนูญ" },
                ];
            }
        }
        function saveHolidays() {
             try {
                state.holidays.sort((a, b) => a.date.localeCompare(b.date)); 
                localStorage.setItem('teacher_roster_holidays_v1', JSON.stringify(state.holidays));
            } catch (e) { showToast('ไม่สามารถบันทึกข้อมูลวันหยุดได้', 'error'); }
        }

        // --- BACKUP & RESTORE ---
        window.exportBackup = () => {
            // (Function remains the same)
            const backupData = {
                roster: state.roster,
                holidays: state.holidays
            };
            const data = JSON.stringify(backupData, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `teacher_roster_backup_${getTodayString('iso')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('กำลังดาวน์โหลดไฟล์สำรองข้อมูล');
        }
        window.triggerImport = () => { dom.importFileInput.click(); }
        window.handleFileImport = (event) => {
            // (อัปเกรด) v20: เพิ่ม Auto-sync
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (Array.isArray(importedData)) {
                            state.roster = importedData;
                            state.holidays = []; 
                            showToast('นำเข้าข้อมูล (เก่า) เรียบร้อย');
                        } else if (importedData.roster && importedData.holidays) {
                            state.roster = importedData.roster;
                            state.holidays = importedData.holidays;
                            showToast('นำเข้าข้อมูล (ใหม่) เรียบร้อย');
                        } else {
                            throw new Error('ไฟล์ไม่ถูกต้อง (ต้องเป็น Array หรือ Object {roster, holidays})');
                        }

                        sortRoster();
                        saveRosterToStorage();
                        saveHolidays();
                        
                        renderHome(); renderRosterList(); renderCalendarView();
                        renderManage(); 
                        window.switchView('view-manage'); 
                        
                        window.triggerAutoSync(); // (ใหม่) v20: Auto-sync
                    } catch (err) { showToast(`เกิดข้อผิดพลาด: ${err.message}`, 'error'); }
                };
                reader.readAsText(file);
            }
            event.target.value = null; 
        }
        
        // --- (อัปเกรด) v20: GOOGLE SHEET SYNC (Auto) ---
        
        /** (ใหม่) v20: ฟังก์ชัน Auto-sync (ทำงานเบื้องหลัง) */
        async function triggerAutoSync() {
            const url = dom.inputAppsScriptUrl.value;
            if (!url) return; // ไม่มี URL, ไม่ต้องทำอะไร

            console.log("Auto-syncing to Google Sheet in background...");
            // ไม่ต้อง disable ปุ่ม หรือ show loading

            try {
                const payload = JSON.stringify(state.roster);
                const response = await fetch(url, {
                    method: 'POST', mode: 'cors', 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: payload
                });
                const result = await response.json();
                if (result.status === 'success') {
                    console.log(`Auto-sync successful: ${result.rows_synced} rows.`);
                } else {
                    throw new Error(result.message || "Unknown error from Apps Script");
                }
            } catch (error) {
                console.error("GSheet Auto-Sync Error:", error);
                // แสดง Toast เฉพาะตอน Error
                showToast(`Auto-sync ล้มเหลว: ${error.message}`, 'error');
            }
        }
        window.triggerAutoSync = triggerAutoSync; // เปิดให้ window เรียกใช้


        // --- HOLIDAY SYNC (v18) ---
        // (Holiday Sync functions remain the same as v18)
        function renderHolidayList() {
            if (state.holidays.length === 0) {
                dom.holidayListContainer.innerHTML = '<p class="text-sm text-slate-400 text-center p-2">กดปุ่มเพื่อค้นหาวันหยุด</p>';
                return;
            }
            dom.holidayListContainer.innerHTML = state.holidays.map(h => `
                <div class="flex justify-between items-center text-sm p-2 bg-holiday-100/50 rounded-lg">
                    <span class="font-semibold text-holiday-500">${h.date}</span>
                    <span class="text-slate-700 truncate ml-2">${h.name}</span>
                </div>
            `).join('');
        }
        window.syncHolidays = async () => {
            const apiKey = dom.inputApiKey.value;
            if (!apiKey) {
                showToast('กรุณากรอก API Key ก่อน', 'error');
                window.switchView('view-manage'); dom.inputApiKey.focus(); return;
            }
            
            const yearToSync = dom.inputHolidayYear.value.trim();
            if (!yearToSync || isNaN(parseInt(yearToSync)) || yearToSync.length !== 4) {
                showToast('กรุณาป้อนปี ค.ศ. 4 หลัก (เช่น 2026)', 'error');
                dom.inputHolidayYear.focus();
                return;
            }

            const btn = dom.btnSyncHolidays;
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-arrows-spin fa-spin mr-2"></i> AI กำลังค้นหา ปี ${yearToSync}...`;

            const model = dom.inputAiModel.value;
            
            const systemPrompt = `
คุณคือ 'AI สกัดข้อมูลวันหยุด' (Holiday Data Extractor)
หน้าที่ของคุณคือการวิเคราะห์ผลการค้นหา (Search Results) เกี่ยวกับวันหยุดราชการไทย
และต้องตอบกลับเป็น **JSON Array ที่สมบูรณ์เท่านั้น**
รูปแบบ: [
    { "date": "YYYY-MM-DD", "name": "ชื่อวันหยุด (ภาษาไทย)" }
]
- ห้ามมีข้อความอื่น ห้ามมี markdown (เช่น \`\`\`json)
- 'date' ต้องเป็น "YYYY-MM-DD" และต้องเป็นของปี ${yearToSync}
`;
            const userQuery = `ค้นหาวันหยุดราชการไทย ${yearToSync}`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            const payload = {
                systemInstruction: { parts: [{ text: systemPrompt }] },
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }] 
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(errorBody.error?.message || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!text) {
                    throw new Error("AI ไม่ได้ส่งข้อมูล JSON กลับมา (อาจเกิดจากผลการค้นหาไม่ดี)");
                }

                const cleanJsonString = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const holidayData = JSON.parse(cleanJsonString);

                if (Array.isArray(holidayData)) {
                    
                    const otherYearHolidays = state.holidays.filter(h => 
                        !h.date.startsWith(yearToSync)
                    );
                    const newHolidayList = [...otherYearHolidays, ...holidayData];
                    state.holidays = newHolidayList;
                    saveHolidays(); 
                    
                    renderHolidayList();
                    renderCalendarView(); 
                    renderHome(); 
                    showToast(`อัปเดตวันหยุด ${holidayData.length} รายการสำหรับปี ${yearToSync} สำเร็จ!`);
                } else {
                    throw new Error("AI ตอบกลับมาในรูปแบบ JSON ที่ไม่ถูกต้อง");
                }

            } catch (error) {
                console.error("Holiday Sync Error:", error);
                showToast(`ซิงค์วันหยุดล้มเหลว: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i class="fa-solid fa-magnifying-glass-chart mr-2"></i> อัปเดตวันหยุด (AI Search)`;
            }
        };

        // --- (v17) Image Attachment Functions ---
        // (All image functions remain the same)
        window.triggerImageUpload = () => {
            dom.imageUploadInput.click();
        }
        window.handleImageUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (!['image/jpeg', 'image/png'].includes(file.type)) {
                showToast('รองรับเฉพาะไฟล์ .jpg หรือ .png เท่านั้น', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;
                const base64String = dataUrl.split(',')[1];
                
                state.attachedFile = {
                    base64: base64String,
                    mimeType: file.type,
                    dataUrl: dataUrl
                };
                
                renderImagePreview();
            };
            reader.readAsDataURL(file);
        }
        function renderImagePreview() {
            dom.imagePreviewContainer.innerHTML = `
                <img src="${state.attachedFile.dataUrl}" alt="Preview">
                <button id="remove-image-btn" type="button" onclick="window.removeImagePreview()">
                    <i class="fa-solid fa-times text-xs"></i>
                </button>
            `;
            dom.imagePreviewContainer.style.display = 'block';
        }
        window.removeImagePreview = () => {
            state.attachedFile = { base64: null, mimeType: null, dataUrl: null };
            dom.imagePreviewContainer.innerHTML = '';
            dom.imagePreviewContainer.style.display = 'none';
            dom.imageUploadInput.value = null; 
        }

        // --- (v17) AI CHAT LOGIC ---
        // (Chat helper functions remain the same)
        function addTypingIndicator() {
            if (document.getElementById('ai-typing-indicator')) return; 
            const bubble = document.createElement('div');
            bubble.id = 'ai-typing-indicator';
            bubble.className = 'chat-bubble chat-bubble-ai-typing';
            bubble.innerHTML = `<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>`;
            dom.chatMessageContainer.appendChild(bubble);
            scrollToChatBottom();
        }
        function removeTypingIndicator() {
            const indicator = document.getElementById('ai-typing-indicator');
            if (indicator) indicator.remove();
        }
        window.sendChatMessage = async (event) => {
            // (Function remains the same as v18)
            event.preventDefault();
            if (state.isAiThinking) return; 
            
            const userMessage = dom.chatInput.value.trim();
            if (!userMessage && !state.attachedFile.base64) return; 

            const apiKey = dom.inputApiKey.value;
            if (!apiKey) {
                showToast('กรุณากรอก API Key ก่อน', 'error');
                window.switchView('view-manage'); dom.inputApiKey.focus(); return;
            }

            state.isAiThinking = true;
            dom.chatInput.value = '';
            dom.chatInput.style.height = 'auto'; 
            dom.chatInput.disabled = true; 
            dom.chatSendBtn.disabled = true; 
            dom.attachBtn.disabled = true; 
            
            addMessageToChat('user', userMessage || "(วิเคราะห์รูปภาพ)"); 
            addTypingIndicator(); 

            const model = dom.inputAiModel.value;
            const todayISO = getTodayString('iso'); 
            const todayDayName = DEMO_DATE_TODAY.toLocaleDateString('th-TH', { weekday: 'long' }); 

            const systemPrompt = `
คุณคือ 'AI ผู้ช่วยอัจฉริยะ' (v20)
คุณมีความสามารถ 3 ด้าน:
1.  **ผู้เชี่ยวชาญตารางเวร (หลัก):** คุณจัดการข้อมูลตารางเวร (Roster) และวันหยุด (Holidays)
2.  **นักวิเคราะห์ (ภาพ):** คุณสามารถวิเคราะห์รูปภาพที่ผู้ใช้แนบมาได้ (เช่น อ่านตารางเวรจากภาพ)
3.  **นักค้นคว้า (Search):** คุณสามารถใช้ Google Search ค้นหาข้อมูลทั่วไป "ทุกเรื่อง"

ข้อเท็จจริงปัจจุบัน:
-   วันนี้คือวันที่ ${todayISO} (${todayDayName})
-   วันที่ทั้งหมดอ้างอิงตามโซนเวลาประเทศไทย (GMT+7)
-   2025-11-17 คือ วันจันทร์ (วันทำงาน)

กฎการทำงาน (สำคัญมาก):
1.  **ตารางเวร:** ห้ามสร้างเวรในวันเสาร์-อาทิตย์ หรือวันหยุดราชการ (Holiday) ที่ระบบรู้จัก
2.  **ค้นหา:** ถ้าผู้ใช้ถามคำถามทั่วไป (เช่น "ราคาทอง", "สูตรอาหาร") ให้ใช้ Google Search
3.  **ผลลัพธ์ (Output):** คุณต้องตอบกลับเป็น JSON เท่านั้น
    A) ถ้าผู้ใช้ "สั่งการ" (เช่น "เพิ่ม", "ลบ", "สร้าง", "สลับ" ตารางเวร)
       -> คุณต้องตอบกลับเป็น **JSON Array (ตารางเวรใหม่)** ที่สมบูรณ์เท่านั้น
       -> 'date' ต้องเป็น "YYYY-MM-DD"
    B) ถ้าผู้ใช้ "ถามคำถาม" (คำถามตารางเวร, คำถามทั่วไป, หรือวิเคราะห์ภาพ)
       -> คุณต้องตอบกลับเป็น **JSON Object ที่มี key "answer"**
       -> Ex: { "answer": "จากการวิเคราะห์ภาพ นี่คือตารางเวรของ..." }
       -> Ex: { "answer": "ค้นหามาแล้วค่ะ ราคาทองวันนี้คือ..." }
    C) ถ้าคำสั่งไม่ชัดเจน ให้ตอบแบบ B (ถามกลับ) -> Ex: { "answer": "ต้องการให้สร้างเวรของเดือนไหนคะ?" }
`;
            
            const recentChat = state.chatHistory.slice(-5).map(m => `${m.role}: ${m.text}`).join('\n');
            const userQuery = `
ตารางเวรปัจจุบัน (JSON):
${JSON.stringify(state.roster)}

วันหยุดราชการที่ระบบรู้จัก (JSON):
${JSON.stringify(state.holidays)}

ประวัติแชทล่าสุด:
${recentChat}

คำสั่งใหม่จากผู้ใช้:
user: "${userMessage}"
`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            const parts = [{ text: userQuery }];
            if (state.attachedFile.base64 && state.attachedFile.mimeType) {
                parts.push({
                    inlineData: {
                        mimeType: state.attachedFile.mimeType,
                        data: state.attachedFile.base64
                    }
                });
            }

            const payload = {
                systemInstruction: { parts: [{ text: systemPrompt }] },
                contents: [{ parts: parts }],
                tools: [{ "google_search": {} }] 
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(errorBody.error?.message || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    removeTypingIndicator(); 
                    processAIResponse(text); 
                } else {
                    throw new Error("AI ไม่ได้ส่งข้อมูลตารางเวรกลับมา");
                }

            } catch (error) {
                console.error("AI Generation Error:", error);
                removeTypingIndicator(); 
                const errorMsg = `AI Error: ${error.message}`;
                addMessageToChat('ai', errorMsg);
                showToast(errorMsg, 'error');
            } finally {
                state.isAiThinking = false;
                dom.chatInput.disabled = false;
                dom.chatSendBtn.disabled = false;
                dom.attachBtn.disabled = false; 
                window.removeImagePreview(); 
                dom.chatInput.focus();
            }
        };

        function addMessageToChat(role, text) {
            state.chatHistory.push({ role, text });
            saveChatHistory();
            renderChatHistory(); 
        }

        /** (อัปเกรด) v20: เพิ่ม Auto-sync */
        function processAIResponse(jsonString) {
            try {
                const cleanJsonString = jsonString.replace(/```json/g, '').replace(/```/g, '').trim();
                const aiData = JSON.parse(cleanJsonString);
                
                if (Array.isArray(aiData)) { 
                    const oldLength = state.roster.length;
                    const newLength = aiData.length;
                    state.roster = aiData; 
                    
                    sortRoster();
                    saveRosterToStorage();
                    
                    let summaryMsg = "ดำเนินการเรียบร้อยค่ะ";
                    if (newLength > oldLength) {
                        summaryMsg = `ฉันเพิ่ม ${newLength - oldLength} รายการ และอัปเดตตารางเวรให้แล้วค่ะ`;
                    } else if (newLength < oldLength) {
                        summaryMsg = `ฉันลบ ${oldLength - newLength} รายการ และอัปเดตตารางเวรให้แล้วค่ะ`;
                    } else if (oldLength === newLength && oldLength > 0) {
                        summaryMsg = "ฉันอัปเดตตารางเวรให้แล้วค่ะ (จำนวนรายการเท่าเดิม)";
                    }

                    addMessageToChat('ai', summaryMsg);
                    showToast(summaryMsg, 'success');
                    
                    renderHome();
                    renderRosterList();
                    renderCalendarView();
                    
                    window.triggerAutoSync(); // (ใหม่) v20: Auto-sync

                } else if (typeof aiData === 'object' && aiData !== null && aiData.answer) {
                    const answer = aiData.answer;
                    addMessageToChat('ai', answer);
                    
                } else {
                    throw new Error("AI response is not a valid Array or Answer Object.");
                }
            } catch (error) {
                console.error("AI Response Parse Error:", error);
                const errorMsg = `AI Error: ${error.message} (AI ตอบกลับ: ${jsonString})`;
                addMessageToChat('ai', errorMsg);
                showToast('AI ตอบกลับในรูปแบบที่ผิดพลาด', 'error');
            }
        }

        // --- CALENDAR VIEW FUNCTIONS ---
        // (switchRosterView, changeMonth remain the same)
        window.switchRosterView = (modeIndex) => { 
            if (modeIndex === 0) {
                dom.rosterListContainer.classList.remove('hidden');
                dom.calendarViewContainer.classList.add('hidden');
                dom.rosterViewBg.style.transform = 'translateX(0%)';
                dom.rosterViewBg.parentElement.children[1].classList.add('active'); 
                dom.rosterViewBg.parentElement.children[2].classList.remove('active'); 
            } else {
                dom.rosterListContainer.classList.add('hidden');
                dom.calendarViewContainer.classList.remove('hidden');
                dom.rosterViewBg.style.transform = 'translateX(100%)';
                dom.rosterViewBg.parentElement.children[1].classList.remove('active'); 
                dom.rosterViewBg.parentElement.children[2].classList.add('active'); 
            }
        }
        window.changeMonth = (direction) => {
            state.calendarMonth.setMonth(state.calendarMonth.getMonth() + direction);
            renderCalendarView();
        }

        /** (อัปเกรด) v20: Render ปฏิทิน (D&D สำหรับ Swap) */
        function renderCalendarView() {
            const today = new Date(getTodayString('iso') + 'T00:00:00'); 
            const currentMonth = state.calendarMonth.getMonth();
            const currentYear = state.calendarMonth.getFullYear();

            dom.calendarMonthYear.textContent = state.calendarMonth.toLocaleDateString('th-TH', {
                month: 'long', year: 'numeric'
            });

            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const startDayOfWeek = firstDayOfMonth.getDay(); 

            let html = '';
            for (let i = 0; i < startDayOfWeek; i++) {
                html += `<div class="calendar-day calendar-day-empty"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateObj = new Date(currentYear, currentMonth, day);
                const dateStr = dateObj.toLocaleDateString('sv-SE'); 
                
                const dutiesForDay = state.roster
                    .map((duty, index) => ({ ...duty, originalIndex: index }))
                    .filter(item => item.date === dateStr);
                    
                const holiday = state.holidays.find(item => item.date === dateStr);
                
                const isToday = (dateObj.getTime() === today.getTime());
                
                // (อัปเกรด) v20: ลบ D&D listeners ออกจาก .calendar-day
                html += `<div class="calendar-day ${isToday ? 'day-today' : ''} ${holiday ? 'day-holiday' : ''}" 
                              data-date="${dateStr}"
                              onclick="window.showDayDetails('${dateStr}')">`;
                              
                html += `<div class="day-number">${day}</div>`;
                
                html += `<div class="duty-chip-container">`;
                
                if (holiday) {
                    html += `<span class="holiday-chip" title="${escapeHTML(holiday.name)}">
                                ${escapeHTML(holiday.name.split(' ')[0])}
                             </span>`;
                }

                if (dutiesForDay.length > 0) {
                    html += dutiesForDay.map(duty => {
                        const shortName = escapeHTML(duty.teacher.replace('ครู', '').trim().split(' ')[0]);
                        // (อัปเกรด) v20: เพิ่ม D&D listeners (สำหรับ Swap) ให้ .duty-chip
                        return `<span class="duty-chip" 
                                      draggable="true" 
                                      data-duty-index="${duty.originalIndex}" 
                                      ondragstart="window.handleDragStart(event)"
                                      ondragend="window.handleDragEnd(event)"
                                      ondragover="window.handleChipDragOver(event)"
                                      ondragleave="window.handleChipDragLeave(event)"
                                      ondrop="window.handleChipDrop(event)"
                                      title="${escapeHTML(duty.teacher)}: ${escapeHTML(duty.duty)}">
                                    ${shortName}
                                </span>`
                    }).join('');
                }
                
                html += `</div></div>`;
            }
            dom.calendarGrid.innerHTML = html;
        }
        
        // --- (อัปเกรด) v20: Drag & Drop (Swap) Functions ---

        window.handleDragStart = (event) => {
            // (Function remains the same)
            const dutyIndex = event.target.dataset.dutyIndex;
            event.dataTransfer.setData("text/plain", dutyIndex);
            event.dataTransfer.effectAllowed = "move";
            setTimeout(() => {
                event.target.classList.add('dragging');
            }, 0);
        };

        window.handleDragEnd = (event) => {
            // (Function remains the same)
            event.target.classList.remove('dragging');
        };

        /** (ใหม่) v20: เมื่อลากผ่าน Chip อื่น */
        window.handleChipDragOver = (event) => {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.add('swap-target');
        };

        /** (ใหม่) v20: เมื่อลากออกจาก Chip อื่น */
        window.handleChipDragLeave = (event) => {
            event.stopPropagation();
            event.currentTarget.classList.remove('swap-target');
        };

        /** (ใหม่) v20: เมื่อวาง Chip ลงบน Chip อื่น (Swap) */
        window.handleChipDrop = (event) => {
            event.preventDefault();
            event.stopPropagation(); // หยุดไม่ให้ event ลอยไปที่ .calendar-day
            event.currentTarget.classList.remove('swap-target');

            const targetIndex = parseInt(event.currentTarget.dataset.dutyIndex, 10);
            const draggedIndex = parseInt(event.dataTransfer.getData("text/plain"), 10);

            if (isNaN(draggedIndex) || isNaN(targetIndex) || draggedIndex === targetIndex) {
                return; // Drop ผิดพลาด หรือ drop ทับตัวเอง
            }

            const dutyA = state.roster[draggedIndex];
            const dutyB = state.roster[targetIndex];

            if (!dutyA || !dutyB) {
                console.error("Swap Error: Cannot find one or both duties.");
                return;
            }

            // --- นี่คือหัวใจสำคัญ: การสลับวันที่ ---
            const dateA = dutyA.date;
            const dateB = dutyB.date;
            dutyA.date = dateB;
            dutyB.date = dateA;

            // 1. Save, Sort, Save
            sortRoster();
            saveRosterToStorage();

            // 2. Re-render UI
            renderCalendarView();
            renderRosterList();
            renderHome(); // อัปเดตหน้าแรกเผื่อวันที่สลับกันคือวันนี้

            // 3. แจ้งเตือน
            showToast(`สลับเวร "${dutyA.duty}" กับ "${dutyB.duty}" สำเร็จ`);
            
            // 4. (ใหม่) v20: Auto-sync
            window.triggerAutoSync();
        };


        // --- Modal Functions (v16) ---
        // (Modal functions remain the same)
        window.showDayDetails = (dateStr) => {
            const dateObj = new Date(dateStr + "T00:00:00");
            dom.modalDate.textContent = dateObj.toLocaleDateString('th-TH', {
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
            });

            const holiday = state.holidays.find(h => h.date === dateStr);
            if (holiday) {
                dom.modalHolidayList.innerHTML = `<p class="font-semibold text-holiday-500">${holiday.name}</p>`;
            } else {
                dom.modalHolidayList.innerHTML = `<p class="text-slate-400 text-sm">ไม่มีวันหยุด</p>`;
            }

            const duties = state.roster.filter(d => d.date === dateStr);
            if (duties.length > 0) {
                dom.modalDutyList.innerHTML = duties.map(d => `
                    <div class="p-2 bg-white rounded-lg border border-slate-100">
                        <p class="font-semibold text-slate-700">${d.teacher}</p>
                        <p class="text-sm text-slate-500">${d.duty}</p>
                    </div>
                `).join('');
            } else {
                dom.modalDutyList.innerHTML = `<p class="text-slate-400 text-sm">ไม่มีเวร</p>`;
            }

            dom.modalContainer.classList.remove('hidden');
        }

        window.hideDayDetails = () => {
            dom.modalContainer.classList.add('hidden');
        }

        // --- Start App ---
        initApp();
    </script>
</body>
</html>
